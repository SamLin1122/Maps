<!DOCTYPE html>
<html>

<head>
  <title>Place Searches</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link rel="stylesheet" href="css.css">
</head>

<body>
  <div id="selection">
    <div>
    <b>Mode of Travel: </b>
    <select id="mode">
      <option value="DRIVING">Driving</option>
      <option value="WALKING">Walking</option>
      <option value="TRANSIT">Transit</option>
    </select>
  </div>
  <div>
    <b>Mode of Food: </b>
    <select id="foodmode">
      <option value="restaurant">Restaurant</option>
      <option value="cafe">Cafe</option>
      <option value="bar">Bar</option>
      <option value="bakery">Bakery</option>
    </select>
  </div>
  <div>
    <b>Searching Distance: </b>
    <input id="distance" type="text" value="500">公尺
  </div>
  </div>


  <div id="map"></div>
  <div id="listing">
    <ul id="results">
    </ul>
  </div>
  <div style="display: none">
    <div id="info-content">
      <table>
        <tr id="iw-url-row" class="iw_table_row">
          <td id="iw-icon" class="iw_table_icon"></td>
          <td id="iw-url"></td>
        </tr>
        <tr id="iw-address-row" class="iw_table_row">
          <td class="iw_attribute_name">Address:</td>
          <td id="iw-address"></td>
        </tr>
        <tr id="iw-distance-row" class="iw_table_row">
          <td class="iw_attribute_name">Distance:</td>
          <td id="iw-distance"></td>
        </tr>
        <tr id="iw-opening-row" class="iw_table_row">
          <td class="iw_attribute_name">營業時間:</td>
          <td id="iw-opening"></td>
        </tr>
        <tr id="iw-phone-row" class="iw_table_row">
          <td class="iw_attribute_name">Telephone:</td>
          <td id="iw-phone"></td>
        </tr>
        <tr id="iw-rating-row" class="iw_table_row">
          <td class="iw_attribute_name">Rating:</td>
          <td id="iw-rating"></td>
        </tr>
        <tr id="iw-website-row" class="iw_table_row">
          <td class="iw_attribute_name">Website:</td>
          <td id="iw-website"></td>
        </tr>
      </table>
    </div>
  </div>

  <script>

    var lp, map, taipei, service, infowindow, origin, destination, directionsService, directionsDisplay, geocoder, DistanceMatrix, distanceResponse
    var markers = []
    var point = []
    var dist = []
    var hostnameRegexp = new RegExp('^https?://.+?/');
    var MARKER_PATH = 'https://developers.google.com/maps/documentation/javascript/images/marker_green';

    function initMap() {
      taipei = new google.maps.LatLng(25.0499358, 121.537079);
      directionsService = new google.maps.DirectionsService;
      map = new google.maps.Map(document.getElementById('map'), {
        center: taipei,
        zoom: 15,
        mapTypeControl: false,
        fullscreenControl: false,
      });
      // ------------------------------------

      directionsDisplay = new google.maps.DirectionsRenderer;
      directionsDisplay.setMap(map);
      document.getElementById('distance').addEventListener('change', function () {
        clearMarkers()
        clearResults()
        directionsDisplay.setMap(null);
        map.setZoom(15)
      })
      document.getElementById('mode').addEventListener('change', function () {
        calculateAndDisplayRoute(directionsService, directionsDisplay);
      });
      document.getElementById('foodmode').addEventListener('change', function () {
        clearMarkers()
        clearResults()
        directionsDisplay.setMap(null);
        map.setZoom(15)
      })

      // ----------------------------------------
      infoWindow = new google.maps.InfoWindow({
        content: document.getElementById('info-content')
      });
      service = new google.maps.places.PlacesService(map);
      google.maps.event.addListener(map, "click", function (event) {
        clearMarkers()
        clearResults()
        document.querySelector("#distance").value <= 500 ? map.setZoom(17) : document.querySelector("#distance").value < 1100 ? map.setZoom(16) : map.setZoom(15)
        var foodmode = document.getElementById('foodmode').value
        // map.setZoom(14)
        origin = event.latLng
        point.push(new google.maps.Marker({
          map: map,
          position: origin,
          animation: google.maps.Animation.BOUNCE,
        }))
        map.setCenter(origin);
        var request = {
          location: origin,
          // bounds: map.getBounds(),
          radius: document.querySelector("#distance").value,
          type: [foodmode]
        };
        service.nearbySearch(request, search);
        directionsDisplay.setMap(null);
      })
      // -------------------------------------------------------------------------------
      geocoder = new google.maps.Geocoder;
      DistanceMatrix = new google.maps.DistanceMatrixService;
    }
    function distance(e) {
      var selectedMode = document.getElementById('mode').value;
      DistanceMatrix.getDistanceMatrix({
        origins: [origin],
        destinations: e,
        travelMode: selectedMode,
        unitSystem: google.maps.UnitSystem.METRIC,
        avoidHighways: false,
        avoidTolls: false
      }, function (response, status) {
        if (status !== 'OK') {
          alert('Error was: ' + status);
        } else {
          distanceResponse = response.rows[0].elements;
          document.getElementById('iw-distance').textContent = distanceResponse[0].distance.text
        }
      });
      // return distanceResponse
    }

    // -------------------------------------------
    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      var selectedMode = document.getElementById('mode').value;
      directionsService.route({
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode[selectedMode]
      }, function (response, status) {
        if (status == 'OK') {
          directionsDisplay.setDirections(response);
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
    }

    // function list() {
    //   var tr = Array.from(document.querySelectorAll("#resultsTable tr"))
    //   distance(dist)
    //   for (var i = 0; i < tr.length; i++) {
    //     tr[i].children[1].innerHTML += `<span >${distanceResponse[i].distance.value}</span>`
    //   }
    //   tr.sort((a, b) => a.children[1].children[0].innerText > b.children[1].children[0].innerText ? 1 : -1)
    // }

    // -------------------------------------------
    function search(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        for (var i = 0; i < results.length; i++) {
          var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
          var markerIcon = MARKER_PATH + markerLetter + '.png';
          addMarker({ coords: results[i].geometry.location }, markerIcon);
          markers[i].placeResult = results[i];
          dist.push(results[i].geometry.location)
          // distance([results[i].geometry.location])
          google.maps.event.addListener(markers[i], 'click', function () { destination = this.position; distance([destination]); });
          google.maps.event.addListener(markers[i], 'click', showInfoWindow);
          setTimeout(dropMarker(i), i * 100);
          addResult(results[i], i);
        }
      }
    }
    function addMarker(place, markerIcon) {
      markers.push(new google.maps.Marker({
        position: place.coords,
        animation: google.maps.Animation.DROP,
        icon: markerIcon
      }))
    }
    function clearMarkers() {
      markers.forEach(e => e.setMap(null))
      markers = []
      point.forEach(e => e.setMap(null))
      point = []
      dist = []

    }

    function dropMarker(i) {
      return function () {
        markers[i].setMap(map);
      };
    }

    function addResult(result, i) {
      var results = document.getElementById('results');
      var markerLetter = String.fromCharCode('A'.charCodeAt(0) + (i % 26));
      var markerIcon = MARKER_PATH + markerLetter + '.png';

      var li = document.createElement('li');

      li.style.backgroundColor = (i % 2 === 0 ? 'rgba(255, 40, 40, 0.4)' : 'rgba(255, 20, 20, 0.5)');
      li.onclick = function () {
        google.maps.event.trigger(markers[i], 'click');
      };


      // var value= distance(d)[0].distance.value  
      // var span = document.createElement('span.none');
      // span.textContent=value
      var icon = document.createElement('img');
      icon.src = markerIcon;
      icon.setAttribute('class', 'placeIcon');
      var name = document.createTextNode(result.name);
      li.appendChild(icon);
      li.appendChild(name);
      // li.appendChild(span);
      results.appendChild(li);
    }
    function clearResults() {
      var results = document.getElementById('results');
      while (results.childNodes[0]) {
        results.removeChild(results.childNodes[0]);
      }
    }

    // ------------------------------------------------------
    function showInfoWindow() {
      directionsDisplay.setMap(map);
      calculateAndDisplayRoute(directionsService, directionsDisplay);
      var marker = this;
      service.getDetails({ placeId: marker.placeResult.place_id },
        function (place, status) {
          if (status !== google.maps.places.PlacesServiceStatus.OK) {
            return;
          }
          infoWindow.open(map, marker);
          buildIWContent(place);
        });
    }

    function buildIWContent(place) {
      // console.log(distanceResponse, place.address_components)
      document.getElementById('iw-icon').innerHTML = '<img' + ' src="' + place.icon + '"/>';
      if (place.website) {
        document.getElementById('iw-url').innerHTML = '<b><a href="' + place.website +
          '">' + place.name + '</a></b>';
      } else {
        document.getElementById('iw-url').innerHTML = '<b><a href="' + place.url +
          '">' + place.name + '</a></b>'
      }
      document.getElementById('iw-address').textContent = place.vicinity;
      if (place.opening_hours) {
        if (place.opening_hours.open_now) {
          document.getElementById('iw-opening').textContent = "Open Now";
        } else {
          document.getElementById('iw-opening').textContent = "Close";
        }
      } else {
        document.getElementById('iw-opening').style.display = "none";
      }

      if (place.formatted_phone_number) {
        document.getElementById('iw-phone-row').style.display = '';
        document.getElementById('iw-phone').textContent =
          place.formatted_phone_number;
      } else {
        document.getElementById('iw-phone-row').style.display = 'none';
      }

      if (place.rating) {
        var ratingHtml = '';
        for (var i = 0; i < 5; i++) {
          if (place.rating < (i + 0.5)) {
            ratingHtml += '&#10025;';
          } else {
            ratingHtml += '&#10029;';
          }
          document.getElementById('iw-rating-row').style.display = '';
          document.getElementById('iw-rating').innerHTML = ratingHtml + " " + place.rating;
        }
      } else {
        document.getElementById('iw-rating-row').style.display = 'none';
      }

      if (place.website) {
        var fullUrl = place.website;
        var website = hostnameRegexp.exec(place.website);
        if (website === null) {
          website = 'http://' + place.website + '/';
          fullUrl = website;
        }
        document.getElementById('iw-website-row').style.display = '';
        document.getElementById('iw-website').innerHTML = `<a href="${website}">${website}<a>`;;
      } else {
        document.getElementById('iw-website-row').style.display = 'none';
      }
    }

  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChL9xzTIOm0p3Vgo1hj98Vcht16Z2Jq5A&libraries=places&language=zh-TW&callback=initMap"
    async defer></script>
</body>

</html>